---
- name: Install munge packages
  ansible.builtin.package:
    name: "{{ munge_packages[ansible_os_family] }}"
    state: present

- name: Check if slurm munge key exists on share
  ansible.builtin.stat:
    path: "{{ slurm_munge_key_path | default('') }}"
  register: slurm_key_path

- name: Set the munge key path
  ansible.builtin.set_fact:
    slurm_munge_key_path: "{{ share_path }}/{{ slurm_dir_name }}/munge.key"
  when: not slurm_key_path.stat.exists

- name: Generate munge key
  ansible.builtin.command: "dd if=/dev/random of={{ slurm_munge_key_path }} bs=1024 count=1"
  when: not slurm_key_path.stat.exists

- name: Check munge dir
  ansible.builtin.file:
    path: /etc/munge
    # mode: 0700
    state: directory

- name: Copy munge key
  ansible.builtin.copy:
    src: "{{ slurm_munge_key_path }}"
    dest: /etc/munge/munge.key
    owner: munge
    group: munge
    remote_src: true
    mode: 0400

- name: Ensure Munge is enabled and running
  ansible.builtin.service:
    name: munge
    enabled: true
    state: started

# Copyright 2024 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---

- name: Include input for DOCA
  ansible.builtin.include_vars: "{{ role_path }}/../../../input/network_config.yml"

- name: Set doca installation way to network
  ansible.builtin.set_fact:
    local_installer: false
  when: nvidia_doca_path | default("", true) | length == 0

- name: Set doca installation way to local
  ansible.builtin.set_fact:
    local_installer: true
  when: nvidia_doca_path | default("", true) | length > 0

# - name: Validate nvidia_doca_version
#   ansible.builtin.assert:
#     that: nvidia_doca_version == "latest"
#     fail_msg: "{{ nvidia_doca_mandatory }}"
#   when: not local_installer

- name: Check if correct nvidia_doca file exists
  block:
    - name: Verify if nvidia_doca offline path is given
      ansible.builtin.assert:
        that: nvidia_doca_path | length > 4
        fail_msg: "{{ nvidia_doca_mandatory }}"

    - name: Check if file is .rpm file
      ansible.builtin.assert:
        that: "'.rpm' in nvidia_doca_path"
        fail_msg: "{{ nvidia_doca_file_type }}"

    - name: Check that nvidia_doca .rpm file exists at mentioned path
      ansible.builtin.stat:
        path: "{{ nvidia_doca_path }}"
      register: stat_result

    - name: Fail if nvidia_doca .rpm file doesn't exist
      ansible.builtin.fail:
        msg: "{{ fail_nvidia_doca + nvidia_doca_path }}"
      when: not stat_result.stat.exists

  when: local_installer

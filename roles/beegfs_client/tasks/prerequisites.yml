#  Copyright 2022 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---

- block:
    - name: unmount prev_beegfs_mount
      command: " umount {{ hostvars['127.0.0.1']['prev_beegfs_mount'] }}"
      changed_when: false
  rescue:
    - name: prev_beegfs_mount status
      fail:
        msg: "{{ prev_beegfs_mount_status_msg }}"
  when: hostvars['127.0.0.1']['prev_beegfs_mount'] | length > 1

- block:
    - name: Fetch SElinux mode
      command: sestatus
      register: selinux_status
      changed_when: false

    - name: Check SELinux status
      fail:
        msg: "{{ selinux_fail_msg }}"
      when: '"SELinux status:                 disabled" not in selinux_status.stdout_lines'

    - name: Fetch kernel version
      command: uname -r
      register: kernel_version
      changed_when: false

    - name: Install kernel-devel package
      package:
        name: "kernel-devel-{{ kernel_version.stdout }}"
        state: present

    - name: Install common packages for BeeGFS client
      package:
        name: "{{ beegfs_common_pkgs_non_leap }}"
        state: present
  when: os_supported_leap not in compute_os
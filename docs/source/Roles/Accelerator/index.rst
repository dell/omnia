GPU accelerator configuration
-------------------------------

The accelerator role allows users to  set up the `AMD ROCm <https://www.amd.com/en/graphics/servers-solutions-rocm>`_ platform or the `CUDA Nvidia toolkit <https://developer.nvidia.com/cuda-zone>`_. These tools allow users to unlock the potential of installed GPUs.

Enter all required parameters in ``input/accelerator_config.yml``.

+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Parameters           | Details                                                                                                                                                                                                                                                                                                                                                                                                                                 |
+======================+=========================================================================================================================================================================================================================================================================================================================================================================================================================================+
| amd_gpu_version      |  This variable accepts the amd gpu   version for the RHEL specific OS version.    Verify if the version provided is present in the repo for the OS   version on your node.  Verify the url   for the compatible version: https://repo.radeon.com/amdgpu/ .  If 'latest' is provided in the variable and   the cluster  os version is rhel 8.5. Then the url transforms to   https://repo.radeon.com/amdgpu/latest/rhel/8.5/main/x86_64/  |
|      ``string``      |                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|      Optional        |      **Default values**: ``22.20.3``                                                                                                                                                                                                                                                                                                                                                                                                    |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| amd_rocm_version     | Required AMD ROCm driver version. Make sure the subscription is enabled   for rocm installation because rocm packages are present in code ready builder   repo for RHEL.  If 'latest' is provided   in the variable, the url transforms to    https://repo.radeon.com/rocm/centos8/latest/main/. Only single   instance is supported by Omnia.                                                                                          |
|      ``string``      |                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|      Optional        |      **Default values**: ``latest/main``                                                                                                                                                                                                                                                                                                                                                                                                |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| cuda_toolkit_version | Required CUDA toolkit version.  By   default latest cuda is installed unless cuda_toolkit_path is specified.  Default: latest (11.8.0).                                                                                                                                                                                                                                                                                                 |
|      ``string``      |                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|      Optional        |      **Default values**: ``latest``                                                                                                                                                                                                                                                                                                                                                                                                     |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| cuda_toolkit_path    | If the latest cuda toolkit is not required, provide an offline copy of   the toolkit installer in the path specified. (Take an RPM copy of the toolkit   from `here <https://developer.nvidia.com/cuda-downloads>`_).  If ``cuda_toolkit_version``  is not latest, giving   ``cuda_toolkit_path``  is mandatory.                                                                                                                        |
|      ``string``      |                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|      Optional        |                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| cuda_stream          | A stream in CUDA is a sequence of operations that execute on the device   in the order in which they are issued by the host code.                                                                                                                                                                                                                                                                                                       |
|    ``string``        |                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|     Optional         |      **Default values**: ``latest-dkms``                                                                                                                                                                                                                                                                                                                                                                                                |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


.. note::
	* Nodes provisioned using the Omnia provision tool do not require a RedHat subscription to run ``accelerator.yml`` on RHEL target nodes.
	* For RHEL target nodes not provisioned by Omnia, ensure that RedHat subscription is enabled on all target nodes. Every target node will require a RedHat subscription.
	* If ``cuda_toolkit_path`` is provided in ``input/provision_config.yml`` and NVIDIA GPUs are available on the target nodes, CUDA packages will be deployed post provisioning without user intervention during the execution of ``provision.yml``.
	* AMD ROCm driver installation is not supported by Omnia on Rocky cluster  nodes.

To install all the latest GPU drivers and toolkits, run: ::

	cd accelerator
	ansible-playbook accelerator.yml -i inventory

(where inventory consists of manager, cluster  and login nodes)

The following configurations take place when running ``accelerator.yml``
	i. Servers with AMD GPUs are identified and the latest GPU drivers and ROCm platforms are downloaded and installed.
	ii. Servers with NVIDIA GPUs are identified and the specified CUDA toolkit is downloaded and installed.
	iii. For the rare servers with both NVIDIA and AMD GPUs installed, all the above mentioned download-ables are installed to the server.
	iv. Servers with neither GPU are skipped.

switch_based
-------------


**Pre requisites**

* IP address for ToR switch needs to be provided.

* Switch port range where all BMC NICs are connected should be provided.

* SNMP v3 should be enabled on the switch.

* Non-admin user credentials for the switch need to be provided.

* IPMI over LAN needs to be enabled for the BMC.

* BMC NICs should have a static IP assigned or be configured in DHCP mode.

* BMC credentials should be the same across all servers and provided as input to Omnia.

* Target servers should be configured to boot in PXE mode with appropriate NIC as the first boot device.

.. warning:: Do not use daisy chain ports in ``switch_based_details`` in ``input/provision_config.yml``. This can cause IP conflicts on servers attached to potential target ports.

.. note:: The IP range *x.y.246.1* - *x.y.255.253* (where x and y are provided by the first two octets of ``bmc_nic_subnet``) are reserved by Omnia.

The following parameters need to be populated in ``input/provision_config.yml`` to discover target nodes using a mapping file.

+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Variable               | Default, Choices                                       | Required/Optional | Description                                                                                                                                                                                                                                                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| network_interface_type | **lom**, dedicated                                     | Required          | The network type used on the Omnia cluster.                                                                                                                                                                                                                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| discovery_mechanism    | **switch_based**, mapping, bmc, snmpwalk               | Required          | The mechanism through which Omnia will discover nodes for provisioning.   For more information on how the mechanisms work, go to `DiscoveryMechanisms   <DiscoveryMechanisms/index>`_.                                                                                                                                                                                                                                                                   |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| provision_os           | **rhel**, rocky                                        | Required          | The operating system to be provisioned on target nodes in the   cluster.                                                                                                                                                                                                                                                                                                                                                                                 |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| provision_os_version   | 8.0, 8.1, 8.2, 8.3, 8.4, 8.5, **8.6**, 8.7             | Required          | OS version of provision_os to be installed.                                                                                                                                                                                                                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| iso_file_path          | "/home/RHEL-8.6.0-20220420.3-x86_64-dvd1.iso"          | Required          | Path where user has placed the iso image that needs to be   provisioned on target nodes. Accepted files are Rocky8-DVD or RHEL-8.x-DVD   (full OS). ``iso_file_path`` should contain the ``provision_os`` and   ``provision_os_version`` values in filename.                                                                                                                                                                                             |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| timezone               | **GMT**,  EST, CET, MST, CST6CDT,   PST8PDT            | Required          | Timezone to be used during OS provisioning. Available timezones are   provided in ``provision/roles/provision_validation/files/timezone.txt``.                                                                                                                                                                                                                                                                                                           |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| language               | **en-US**                                              | Required          | Language to be used during OS provisioning.                                                                                                                                                                                                                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| default_lease_time     | **86400** [21600-86400]                                | Required          | Default lease time for IPs assigned by DHCP                                                                                                                                                                                                                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| provision_password     |                                                        | Required          | * Password set for the root account of target nodes during   provisioning.                                                                                                                                                                                                                                                                                                                                                                               |
|                        |                                                        |                   | * Length >= 8 characters                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|                        |                                                        |                   | * Password must not contain -,\, ',"                                                                                                                                                                                                                                                                                                                                                                                                                     |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| postgresdb_password    |                                                        | Required          | * Password set for the postgresDB on target nodes during   provisioning.                                                                                                                                                                                                                                                                                                                                                                                 |
|                        |                                                        |                   | * Length >= 8 characters                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|                        |                                                        |                   | * Password must not contain -,\, ',"                                                                                                                                                                                                                                                                                                                                                                                                                     |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| node_name              | node                                                   | Required          | * Prefix for target node names, if dynamically allocated.                                                                                                                                                                                                                                                                                                                                                                                                |
|                        |                                                        |                   | * Hostname = node_name + '0000x' + domain_name                                                                                                                                                                                                                                                                                                                                                                                                           |
|                        |                                                        |                   | * Hostname <= 65 characters                                                                                                                                                                                                                                                                                                                                                                                                                              |
|                        |                                                        |                   | * Example: servernode00001.Omnia.test , where ``node_name``=servernode,   ``domain_name``=Omnia.test , 00001 used by Omnia.                                                                                                                                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| domain_name            |                                                        | Required          | * Domain name the user intends to configure on the cluster.                                                                                                                                                                                                                                                                                                                                                                                              |
|                        |                                                        |                   | * Hostname = node_name + '0000x' + domain_name                                                                                                                                                                                                                                                                                                                                                                                                           |
|                        |                                                        |                   | * Hostname <= 65 characters                                                                                                                                                                                                                                                                                                                                                                                                                              |
|                        |                                                        |                   | * Please provide a valid domain name according to the domain name   standards.                                                                                                                                                                                                                                                                                                                                                                           |
|                        |                                                        |                   | * Example: servernode00001.Omnia.test , where ``node_name``=servernode,   ``domain_name``=Omnia.test , 00001 used by Omnia.                                                                                                                                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| public_nic             | eno2                                                   | Required          | The nic/ethernet card that is connected to the public internet.                                                                                                                                                                                                                                                                                                                                                                                          |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_nic              | eno1                                                   | Required          | Admin NIC of Control Plane. This is the shared LOM NIC.                                                                                                                                                                                                                                                                                                                                                                                                  |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_nic_subnet *     | 10.5.0.0                                               | Required          | The subnet within which all Admin IPs are assigned.                                                                                                                                                                                                                                                                                                                                                                                                      |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Switch_based_details   |     - { ip: 100.96.28.139", ports: "1-48,49,50”}       | Optional          | JSON list of switches to query for target nodes                                                                                                                                                                                                                                                                                                                                                                                                          |
|                        |        - { ip: "100.96.28.138",   ports: "1-48,49,50”} |                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Switch_snmp3_username  |                                                        | Optional          | Switch username                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Switch_snmp3_password  |                                                        | Optional          | Switch password                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Ip_start_range         |                                                        | Optional          |                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Ip_end_range           |                                                        | Optional          |                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| primary_dns            |                                                        | optional          | The primary DNS host IP queried to provide Internet access to Compute   Node (through DHCP routing)                                                                                                                                                                                                                                                                                                                                                      |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| secondary_dns          |                                                        | optional          | The secondary DNS host IP queried to provide Internet access to Compute   Node (through DHCP routing)                                                                                                                                                                                                                                                                                                                                                    |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| disk_partition         |   - { mount_point: "",   desired_capacity: "" }        | optional          | User defined disk partition applied to remote servers. The disk partition   desired_capacity has to be provided in MB. Valid mount_point values accepted   for disk partition are /home, /var, /tmp, /usr, swap. Default partition size   provided for /boot is 1024MB, /boot/efi is 256MB and the remaining space to /   partition.  Values are accepted in the   form of JSON list such as: , - { mount_point: "/home",   desired_capacity: "102400" } |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| mlnx_ofed_path         |                                                        | optional          | Absolute path to a  local copy of   the .iso file containing Mellanox OFED packages. The image can be downloaded   from https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/.  Sample value:   ``/root/MLNX_OFED_LINUX-5.8-1.1.2.1-rhel8.6-x86_64.iso``                                                                                                                                                                               |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| cuda_toolkit_path      |                                                        | optional          | Absolute path to local copy of .rpm file containing CUDA packages. The   cuda rpm can be downloaded from https://developer.nvidia.com/cuda-downloads.   CUDA will be installed post provisioning without any user intervention. Eg:   cuda_toolkit_path: "/root/cuda-repo-rhel8-12-0-local-12.0.0_525.60.13-1.x86_64.rpm"                                                                                                                                |
+------------------------+--------------------------------------------------------+-------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
